<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Science Bowl Reader (Buzzer Mode)</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
  <script>
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';
  </script>
  <style>
    body {
      font-family: sans-serif;
      padding: 30px;
      max-width: 800px;
      margin: auto;
    }
    .box {
      border: 1px solid #ccc;
      padding: 20px;
      border-radius: 10px;
      margin-top: 20px;
    }
    button {
      padding: 10px 20px;
      margin-top: 10px;
      font-size: 16px;
      cursor: pointer;
    }
    #questionDisplay {
      border: 1px solid #eee;
      padding: 15px;
      border-radius: 5px;
      background: #f9f9f9;
      min-height: 200px;
      line-height: 1.6;
    }
    #debugInfo {
      display: none;
      margin-top: 20px;
      padding: 10px;
      background: #f5f5f5;
      border-radius: 5px;
      white-space: pre-wrap;
      max-height: 300px;
      overflow-y: auto;
    }
    #ttsControls {
      margin-top: 15px;
      padding: 10px;
      background: #f0f8ff;
      border-radius: 5px;
    }
    .cursor {
      display: inline-block;
      width: 2px;
      height: 1em;
      background: black;
      animation: blink 1s infinite;
      vertical-align: middle;
    }
    @keyframes blink {
      50% { opacity: 0; }
    }
    #answerInput {
      margin-top: 10px;
      padding: 8px;
      width: 100%;
      font-size: 16px;
    }
    #submitAnswer {
      margin-top: 5px;
    }
    #resultMessage {
      margin-top: 10px;
      font-weight: bold;
      min-height: 20px;
    }
    .correct {
      color: green;
    }
    .incorrect {
      color: red;
    }
    #buzzerStatus {
      position: fixed;
      top: 10px;
      right: 10px;
      padding: 10px;
      background: #ffcccc;
      border-radius: 5px;
      display: none;
    }
  </style>
</head>
<body>
  <div id="buzzerStatus">BUZZED!</div>
  <h1>Science Bowl Practice (Buzzer Mode)</h1>
  <input type="file" accept="application/pdf" id="pdfInput" />
  <button id="debugBtn">Show Debug Info</button>
  <div id="debugInfo"></div>
  <div class="box" id="questionBox" style="display:none;">
    <h2 id="questionTitle"></h2>
    <div id="questionDisplay"></div>
    
    <div id="answerSection" style="display:none;">
      <input type="text" id="answerInput" placeholder="Type your answer..." />
      <button id="submitAnswer">Submit Answer</button>
      <div id="resultMessage"></div>
      <p><strong>Correct Answer:</strong> <span id="correctAnswer"></span></p>
    </div>
    
    <div id="ttsControls">
      <button id="readAloudBtn">Read Aloud</button>
      <button id="nextBtn">Next Question</button>
      <label>Speed: <input type="range" id="speedControl" min="0.5" max="2" step="0.1" value="1"></label>
    </div>
  </div>

  <script>
    // DOM Elements
    const elements = {
      pdfInput: document.getElementById("pdfInput"),
      questionBox: document.getElementById("questionBox"),
      questionTitle: document.getElementById("questionTitle"),
      questionDisplay: document.getElementById("questionDisplay"),
      debugBtn: document.getElementById("debugBtn"),
      debugInfo: document.getElementById("debugInfo"),
      readAloudBtn: document.getElementById("readAloudBtn"),
      nextBtn: document.getElementById("nextBtn"),
      speedControl: document.getElementById("speedControl"),
      answerSection: document.getElementById("answerSection"),
      answerInput: document.getElementById("answerInput"),
      submitAnswer: document.getElementById("submitAnswer"),
      resultMessage: document.getElementById("resultMessage"),
      correctAnswer: document.getElementById("correctAnswer"),
      buzzerStatus: document.getElementById("buzzerStatus")
    };

    // State variables
    let state = {
      questions: [],
      currentIndex: 0,
      synth: window.speechSynthesis,
      currentUtterance: null,
      typewriterInterval: null,
      fullQuestionText: "",
      isBuzzed: false
    };

    // Initialize
    elements.debugBtn.addEventListener("click", () => {
      elements.debugInfo.style.display = elements.debugInfo.style.display === "none" ? "block" : "none";
    });

    // Event listeners
    elements.readAloudBtn.addEventListener("click", readAloud);
    elements.nextBtn.addEventListener("click", nextQuestion);
    elements.speedControl.addEventListener("input", updateSpeechRate);
    elements.submitAnswer.addEventListener("click", checkAnswer);
    elements.answerInput.addEventListener("keypress", (e) => {
      if (e.key === "Enter") checkAnswer();
    });

    // Keyboard shortcuts
    document.addEventListener("keydown", (e) => {
      if (e.key === " " && !state.isBuzzed) { // Spacebar to buzz
        e.preventDefault();
        buzzIn();
      } else if (e.key.toLowerCase() === "n") { // N for next question
        nextQuestion();
      }
    });

    function updateSpeechRate() {
      if (state.currentUtterance) {
        state.currentUtterance.rate = elements.speedControl.value;
      }
    }

    function buzzIn() {
      if (state.isBuzzed) return;
      
      state.isBuzzed = true;
      elements.buzzerStatus.style.display = "block";
      
      // Stop any ongoing reading/typing
      if (state.synth.speaking) state.synth.cancel();
      clearInterval(state.typewriterInterval);
      
      // Show full question immediately
      elements.questionDisplay.innerHTML = state.fullQuestionText;
      
      // Show answer input
      elements.answerSection.style.display = "block";
      elements.answerInput.focus();
    }

    function checkAnswer() {
      const userAnswer = elements.answerInput.value.trim().toLowerCase();
      const correctAnswer = state.questions[state.currentIndex].answer.trim().toLowerCase();
      
      // Simple answer comparison (could be enhanced for more flexibility)
      const isCorrect = userAnswer === correctAnswer;
      
      elements.resultMessage.textContent = isCorrect ? "Correct!" : "Incorrect";
      elements.resultMessage.className = isCorrect ? "correct" : "incorrect";
      elements.correctAnswer.textContent = state.questions[state.currentIndex].answer;
    }

    function readAloud() {
      if (state.synth.speaking) state.synth.cancel();
      
      state.currentUtterance = new SpeechSynthesisUtterance(
        state.questions[state.currentIndex].question.replace(/<br>/g, " ")
      );
      state.currentUtterance.rate = elements.speedControl.value;
      state.synth.speak(state.currentUtterance);
    }

    function startTypewriterEffect() {
      clearInterval(state.typewriterInterval);
      state.isBuzzed = false;
      elements.buzzerStatus.style.display = "none";
      elements.answerSection.style.display = "none";
      elements.answerInput.value = "";
      elements.resultMessage.textContent = "";
      elements.correctAnswer.textContent = "";
      
      let currentCharIndex = 0;
      elements.questionDisplay.innerHTML = '<span class="cursor"></span>';
      
      state.typewriterInterval = setInterval(() => {
        if (currentCharIndex < state.fullQuestionText.length && !state.isBuzzed) {
          // Get next character (handling HTML tags specially)
          let nextChar = state.fullQuestionText[currentCharIndex];
          
          // If we're at the start of a <br> tag, add the whole tag at once
          if (state.fullQuestionText.substr(currentCharIndex, 4) === "<br>") {
            nextChar = "<br>";
            currentCharIndex += 3; // Skip ahead
          }
          
          elements.questionDisplay.innerHTML = 
            state.fullQuestionText.substring(0, currentCharIndex + 1) + 
            '<span class="cursor"></span>';
          
          currentCharIndex++;
          
          // Scroll to keep the cursor visible
          const cursor = document.querySelector(".cursor");
          if (cursor) {
            cursor.scrollIntoView({ behavior: "smooth", block: "nearest" });
          }
        } else {
          clearInterval(state.typewriterInterval);
          elements.questionDisplay.innerHTML = state.fullQuestionText; // Remove cursor when done
        }
      }, 30); // Adjust typing speed here (lower = faster)
    }

    // PDF Processing
    elements.pdfInput.addEventListener("change", async function() {
      const file = this.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = async function() {
        const typedArray = new Uint8Array(this.result);
        const pdf = await pdfjsLib.getDocument({ data: typedArray }).promise;

        let fullText = "";
        for (let i = 1; i <= pdf.numPages; i++) {
          const page = await pdf.getPage(i);
          const content = await page.getTextContent();
          fullText += content.items.map(i => i.str).join(" ") + "\n";
        }

        elements.debugInfo.textContent = "First 1000 characters of PDF:\n" + fullText.substring(0, 1000);
        fullText = fullText.replace(/\s+/g, ' ');
        const questionBlocks = fullText.split(/(TOSS UP|BONUS)/i);
        
        state.questions = [];
        
        for (let i = 1; i < questionBlocks.length; i += 2) {
          const type = questionBlocks[i].trim();
          const block = questionBlocks[i+1];
          
          try {
            const headerMatch = block.match(/(\d+)\) (PHYSICS|MATH) (Multiple Choice|Short Answer)/i);
            if (!headerMatch) continue;
            
            const number = headerMatch[1];
            const category = headerMatch[2].toUpperCase();
            const style = headerMatch[3];
            
            const answerPos = block.indexOf("ANSWER:");
            if (answerPos === -1) continue;
            
            let questionBody = block.substring(headerMatch[0].length, answerPos).trim();
            let answer = block.substring(answerPos + "ANSWER:".length).trim();
            answer = answer.split(/(?=TOSS UP|BONUS|MIT Science Bowl|Page \d+)/i)[0].trim();
            
            if (answer === ')' || answer === ') )') {
              const answerInQuestion = questionBody.match(/\[([^\]]+)\]|\(([^)]+)\)/);
              if (answerInQuestion) {
                answer = answerInQuestion[1] || answerInQuestion[2];
              } 
              else if (category === 'PHYSICS' && questionBody.includes('factor')) {
                const factorMatch = questionBody.match(/(\d+(?:\.\d+)?)\s*(?:times|×)/i);
                answer = factorMatch ? factorMatch[1] : "1/2";
              }
              else if (category === 'MATH') {
                const mathMatch = questionBody.match(/(\d+)\b/);
                answer = mathMatch ? mathMatch[1] : answer;
              }
            }
            
            questionBody = questionBody.replace(/MIT Science Bowl.*$/, '')
                                     .replace(/Page \d+.*$/, '')
                                     .trim();
            
            answer = answer.replace(/MIT Science Bowl.*$/, '')
                          .replace(/Page \d+.*$/, '')
                          .trim();
            
            if (!questionBody || !answer) continue;
            
            if (style === "Multiple Choice") {
              questionBody = questionBody.replace(/\s([WXYZ]\))/g, "\n$1");
            }
            
            state.questions.push({
              number,
              category,
              style,
              question: questionBody,
              answer,
              type
            });
          } catch (e) {
            console.warn("Error parsing question block:", e, block);
          }
        }

        if (state.questions.length === 0) {
          alert("No Math/Physics questions found. Please check the debug info.");
          return;
        }

        state.currentIndex = 0;
        showQuestion();
        elements.questionBox.style.display = "block";
      };

      reader.readAsArrayBuffer(file);
    });

    function showQuestion() {
      const q = state.questions[state.currentIndex];
      elements.questionTitle.textContent = `${q.type} ${q.number} - ${q.category} ${q.style}`;
      state.fullQuestionText = q.question.replace(/\n/g, "<br>");
      
      // Start typewriter effect immediately
      startTypewriterEffect();
    }

    function nextQuestion() {
      state.currentIndex = (state.currentIndex + 1) % state.questions.length;
      showQuestion();
    }
  </script>
</body>
</html>
