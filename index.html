<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Science Bowl Single Player</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
  <script>
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';
  </script>
  <style>
    body {
      font-family: sans-serif;
      padding: 30px;
      max-width: 800px;
      margin: auto;
    }
    .box {
      border: 1px solid #ccc;
      padding: 20px;
      border-radius: 10px;
      margin-top: 20px;
    }
    button {
      padding: 10px 20px;
      margin-top: 10px;
      font-size: 16px;
    }
    .multiple-choice {
      line-height: 1.6;
    }
    #debugInfo {
      display: none;
      margin-top: 20px;
      padding: 10px;
      background: #f5f5f5;
      border-radius: 5px;
      white-space: pre-wrap;
      max-height: 300px;
      overflow-y: auto;
    }
  </style>
</head>
<body>
  <h1>Science Bowl Practice (Math & Physics)</h1>
  <input type="file" accept="application/pdf" id="pdfInput" />
  <button id="debugBtn">Show Debug Info</button>
  <div id="debugInfo"></div>
  <div class="box" id="questionBox" style="display:none;">
    <h2 id="questionTitle"></h2>
    <div id="questionText" class="multiple-choice"></div>
    <p id="answerText" style="display:none;"><strong>ANSWER:</strong> <span id="answerContent"></span></p>
    <button id="showAnswerBtn">Show Answer</button>
    <button id="nextBtn">Next Question</button>
  </div>

  <script>
    const pdfInput = document.getElementById("pdfInput");
    const questionBox = document.getElementById("questionBox");
    const questionTitle = document.getElementById("questionTitle");
    const questionText = document.getElementById("questionText");
    const answerText = document.getElementById("answerText");
    const answerContent = document.getElementById("answerContent");
    const showAnswerBtn = document.getElementById("showAnswerBtn");
    const nextBtn = document.getElementById("nextBtn");
    const debugBtn = document.getElementById("debugBtn");
    const debugInfo = document.getElementById("debugInfo");

    let questions = [], currentIndex = 0;

    debugBtn.addEventListener("click", () => {
      debugInfo.style.display = debugInfo.style.display === "none" ? "block" : "none";
    });

    pdfInput.addEventListener("change", async function () {
      const file = this.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = async function () {
        const typedArray = new Uint8Array(this.result);
        const pdf = await pdfjsLib.getDocument({ data: typedArray }).promise;

        let fullText = "";
        for (let i = 1; i <= pdf.numPages; i++) {
          const page = await pdf.getPage(i);
          const content = await page.getTextContent();
          fullText += content.items.map(i => i.str).join(" ") + "\n";
        }

        debugInfo.textContent = "First 1000 characters of PDF:\n" + fullText.substring(0, 1000);
        
        // First normalize all whitespace
        fullText = fullText.replace(/\s+/g, ' ');
        
        // Split by TOSS UP or BONUS
        const questionBlocks = fullText.split(/(TOSS UP|BONUS)/i);
        
        questions = [];
        
        for (let i = 1; i < questionBlocks.length; i += 2) {
          const type = questionBlocks[i].trim();
          const block = questionBlocks[i+1];
          
          try {
            // Look for the pattern: number) CATEGORY TYPE
            const headerMatch = block.match(/(\d+)\) (PHYSICS|MATH) (Multiple Choice|Short Answer)/i);
            if (!headerMatch) continue;
            
            const number = headerMatch[1];
            const category = headerMatch[2].toUpperCase();
            const style = headerMatch[3];
            
            // Find the position of ANSWER:
            const answerPos = block.indexOf("ANSWER:");
            if (answerPos === -1) continue;
            
            // Extract question text
            let questionBody = block.substring(headerMatch[0].length, answerPos).trim();
            
            // Extract answer text - take everything after ANSWER: until next question or page marker
            let answer = block.substring(answerPos + "ANSWER:".length).trim();
            
            // Remove everything after the actual answer
            answer = answer.split(/(?=TOSS UP|BONUS|MIT Science Bowl|Page \d+)/i)[0].trim();
            
            // Special handling for answers that start with ) or )
            if (answer.startsWith(')') || answer.startsWith(') )')) {
              // Look for the actual answer before the parentheses
              const answerMatch = block.substring(0, answerPos).match(/([WXYZ]\)|[A-Za-z0-9].*?)(?=\s*\)\s*$)/);
              if (answerMatch) {
                answer = answerMatch[1].trim();
              }
            }
            
            // Final cleanup
            questionBody = questionBody.replace(/MIT Science Bowl.*$/, '')
                                     .replace(/Page \d+.*$/, '')
                                     .trim();
            
            answer = answer.replace(/MIT Science Bowl.*$/, '')
                          .replace(/Page \d+.*$/, '')
                          .trim();
            
            if (!questionBody || !answer) continue;
            
            // Format multiple choice options
            if (style === "Multiple Choice") {
              questionBody = questionBody.replace(/\s([WXYZ]\))/g, "\n$1");
            }
            
            questions.push({
              number,
              category,
              style,
              question: questionBody,
              answer,
              type
            });
          } catch (e) {
            console.warn("Error parsing question block:", e, block);
          }
        }

        if (questions.length === 0) {
          alert("No Math/Physics questions found. Please check the debug info.");
          return;
        }

        currentIndex = 0;
        showQuestion();
        questionBox.style.display = "block";
      };

      reader.readAsArrayBuffer(file);
    });

    function showQuestion() {
      const q = questions[currentIndex];
      questionTitle.textContent = `${q.type} ${q.number} - ${q.category} ${q.style}`;
      questionText.innerHTML = q.question.replace(/\n/g, "<br>");
      answerContent.textContent = q.answer;
      answerText.style.display = "none";
    }

    showAnswerBtn.addEventListener("click", () => {
      answerText.style.display = "block";
    });

    nextBtn.addEventListener("click", () => {
      currentIndex = (currentIndex + 1) % questions.length;
      showQuestion();
    });
  </script>
</body>
</html>
