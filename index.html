<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Science Bowl Single Player</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
  <script>
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';
  </script>
  <style>
    body {
      font-family: sans-serif;
      padding: 30px;
      max-width: 800px;
      margin: auto;
    }
    .box {
      border: 1px solid #ccc;
      padding: 20px;
      border-radius: 10px;
      margin-top: 20px;
    }
    button {
      padding: 10px 20px;
      margin-top: 10px;
      font-size: 16px;
    }
    pre {
      white-space: pre-wrap;
    }
  </style>
</head>
<body>
  <h1>Science Bowl Practice (Math & Physics)</h1>
  <input type="file" accept="application/pdf" id="pdfInput" />
  <div class="box" id="questionBox" style="display:none;">
    <h2 id="questionTitle"></h2>
    <pre id="questionText"></pre>
    <p id="answerText" style="display:none;"><strong>ANSWER:</strong> <span id="answerContent"></span></p>
    <button id="showAnswerBtn">Show Answer</button>
    <button id="nextBtn">Next Question</button>
  </div>

  <script>
    const pdfInput = document.getElementById("pdfInput");
    const questionBox = document.getElementById("questionBox");
    const questionTitle = document.getElementById("questionTitle");
    const questionText = document.getElementById("questionText");
    const answerText = document.getElementById("answerText");
    const answerContent = document.getElementById("answerContent");
    const showAnswerBtn = document.getElementById("showAnswerBtn");
    const nextBtn = document.getElementById("nextBtn");

    let questions = [], currentIndex = 0;

    pdfInput.addEventListener("change", async function () {
      const file = this.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = async function () {
        const typedArray = new Uint8Array(this.result);
        const pdf = await pdfjsLib.getDocument({ data: typedArray }).promise;

        let fullText = "";
        for (let i = 1; i <= pdf.numPages; i++) {
          const page = await pdf.getPage(i);
          const content = await page.getTextContent();
          fullText += content.items.map(i => i.str).join(" ") + "\n";
        }

        // Split text by Toss-up or Bonus questions
        // The regex includes the question number and type for clearer splitting
        const blocks = fullText.split(/(\d+\s*(TOSS[- ]?UP|BONUS))/i).filter(s => s.trim() !== "");

        // The split creates an array mixing numbers, type labels, and question texts.
        // We reconstruct the questions by grouping every 3 items: [number, type, text]
        let parsedQuestions = [];
        for (let i = 0; i < blocks.length - 2; i += 3) {
          const number = blocks[i].trim();
          const typeRaw = blocks[i+1].trim().toUpperCase();
          const text = blocks[i+2].trim();

          // Only keep math or physics questions
          if (!/math|physics/i.test(text)) continue;

          // Extract question type ("TOSS-UP" or "BONUS") properly normalized
          const qType = typeRaw.includes("BONUS") ? "BONUS" : "TOSS-UP";

          // Extract category and question style
          const catMatch = text.match(/(MATH|PHYS)\s+(Multiple Choice|Short Answer)/i);
          const category = catMatch ? catMatch[1].toUpperCase() : "";
          const style = catMatch ? catMatch[2] : "";

          // Extract the question text before next question or ANSWER
          // Sometimes questions have extra ANSWER text inside, we'll extract answer separately
          let questionTextRaw = text.replace(/ANSWER[\s\S]*/i, "").trim();

// Format multiple choice options on new lines
if (style.toLowerCase() === "multiple choice") {
  questionTextRaw = questionTextRaw.replace(/\s([WXYZ]\))/g, "\n$1");
}

// Extract answer separately (everything after ANSWER)
const answerMatch = text.match(/ANSWER[^:]*:?\s*([\s\S]*)$/i);
let answerTextRaw = answerMatch ? answerMatch[1].trim() : "[No answer found]";

parsedQuestions.push({
  number,
  qType,
  category,
  style,
  question: questionTextRaw,
  answer: answerTextRaw
});

        questions = parsedQuestions;
        if (questions.length === 0) {
          alert("No Math or Physics questions found.");
          return;
        }

        currentIndex = 0;
        showQuestion();
      };

      reader.readAsArrayBuffer(file);
    });

    function showQuestion() {
      const q = questions[currentIndex];
      questionTitle.textContent = `Question ${q.number} - ${q.category} ${q.qType.charAt(0).toUpperCase() + q.qType.slice(1).toLowerCase()}`;
      questionText.textContent = q.question;
      answerContent.textContent = q.answer;
      answerText.style.display = "none";
      questionBox.style.display = "block";
    }

    showAnswerBtn.onclick = () => {
      answerText.style.display = "block";
    };

    nextBtn.onclick = () => {
      currentIndex = (currentIndex + 1) % questions.length;
      showQuestion();
    };
  </script>
</body>
</html>
